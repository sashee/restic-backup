# Maintainer: Tamas Sallai <tamas.sallai@advancedweb.hu>
pkgname="restic-backup-client"
pkgver="0.0.1"
pkgrel="1"
pkgdesc="Restic backup to an S3-compatible storage"
arch=(any)
license=("MPL-2.0")
url="https://github.com/sashee/restic-backup"
source=("index.js" "package.json" "package-lock.json" "restic-backup-client@.service" "restic-backup-client@.timer")
depends=('nodejs' 'restic')
makedepends=('npm' 'jq')
sha512sums=("SKIP" "SKIP" "SKIP" "SKIP" "SKIP")

build() {
	npm ci
}

package() {
	VERSION="$pkgver-$pkgrel"
	PACKAGE_JSON_VERSION=$(cat package.json| jq -r '.version')
	
	if [ "$VERSION" != "$PACKAGE_JSON_VERSION" ]; then
		echo "version mismatch $VERSION != $PACKAGE_JSON_VERSION"
		exit 1
	fi
  mkdir -p "${pkgdir}/usr/lib/restic-backup-client"
  cp -Lr "${srcdir}/node_modules" "${pkgdir}/usr/lib/restic-backup-client/node_modules"
  cp "${srcdir}/index.js" "${pkgdir}/usr/lib/restic-backup-client/index.js"
  cp "${srcdir}/package.json" "${pkgdir}/usr/lib/restic-backup-client/package.json"
  cp "${srcdir}/package-lock.json" "${pkgdir}/usr/lib/restic-backup-client/package-lock.json"
  mkdir -p "${pkgdir}/usr/lib/systemd/system"
	cp "${srcdir}/restic-backup-client@.service" "${pkgdir}/usr/lib/systemd/system"
	cp "${srcdir}/restic-backup-client@.timer" "${pkgdir}/usr/lib/systemd/system"
}

